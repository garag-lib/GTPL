/*!
* gtpl v1.1.1
* (c) 2024 Manuel Peliz
* @license LGPL-2.1 license
* @repository https://github.com/garag-lib/GTPL
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).gtpl=t()}(this,function(){"use strict";function e(e){const t={},n=e.toLowerCase().replace(/-(.)/g,(e,t)=>t.toUpperCase()).replace(/;\s?$/g,"").split(/:|;/g);for(let e=0,i=n.length;e<i;e+=2)t[n[e].replace(/\s/g,"")]=n[e+1].replace(/^\s+|\s+$/g,"");return t}function t(e){return e.replace(/([a-z])([A-Z])/g,"$1-$2").toLocaleLowerCase()}const n=["symbol","bigint","undefined","boolean","string","number"];function i(e){if(null==e)return!0;const t=typeof e;return n.includes(t)}function s(...e){console.log("%c----------","font-weight:bold"),e.forEach(e=>{console.log(e)}),console.log("%c----------","font-weight:bold")}function r(...e){e.push(new Error(e.shift()).stack),s(...e)}const o={useScheduler:!1,batchDepth:0,microtaskQueued:!1},l=new Set;function a(e){o.batchDepth++;try{e()}finally{o.batchDepth--,0===o.batchDepth&&l.size>0&&h()}}function h(){if(console.log("flushHandlers"),!(o.batchDepth>0)&&0!==l.size){console.log("flushHandlers",l);for(const e of l)try{e()}catch(e){console.error("[flushHandlers] Error:",e)}l.clear(),o.microtaskQueued=!1}}function c(e){console.log("enqueueHandler",e),l.add(e),o.microtaskQueued||0!==o.batchDepth||(o.microtaskQueued=!0,queueMicrotask(()=>{o.microtaskQueued=!1}))}const u=Symbol("is proxy"),f=Symbol("proxy target"),p=new WeakMap,d=new WeakMap,g=()=>{};function m(e){return!!e&&"object"==typeof e&&u in e}function y(e,t,n,s=[]){if(i(e))return e;const r=p.get(e);if(r)return d.get(e).add(t),r.proxy;const l=function(e,t,n=[]){return{get(s,r,o){if(r===u)return!0;if(r===f)return e;if(r===Symbol.iterator){const e=s[Symbol.iterator].bind(s);return function*(){for(const s of e())yield i(s)||m(s)?s:y(s,g,t,[...n,Symbol.iterator])}}const l=Reflect.get(s,r,o);return i(l)||m(l)?l:y(l,g,t,[...n,r])},set(i,s,r,l){m(r)&&(r=r[f]);const a=Reflect.set(i,s,r,l),h=d.get(e);return o.useScheduler?h?.forEach(e=>c(()=>e(0,[...n,s],r,t))):h?.forEach(e=>e(0,[...n,s],r,t)),a},deleteProperty(i,s){const r=Reflect.deleteProperty(i,s),l=d.get(e);return o.useScheduler?l?.forEach(e=>c(()=>e(1,[...n,s],void 0,t))):l?.forEach(e=>e(1,[...n,s],void 0,t)),r},has:(e,t)=>Reflect.has(e,t),ownKeys:e=>Reflect.ownKeys(e),getOwnPropertyDescriptor:(e,t)=>Reflect.getOwnPropertyDescriptor(e,t)}}(e,n,s),{proxy:a,revoke:h}=Proxy.revocable(e,l);return p.set(e,{proxy:a,revoke:h}),d.set(e,new Set([t])),a}const k=y;function v(e,t){m(e)&&(e=e[f]);const n=d.get(e);if(n&&(n.delete(t),0===n.size)){d.delete(e);const n=p.get(e);if(n){try{n.revoke()}catch(e){console.error("[GProxy] Error revoking proxy:",e)}p.delete(e)}e&&"object"==typeof e&&Object.keys(e).forEach(n=>{const i=e[n];if(i&&"object"==typeof i){const e=d.get(i);e&&0===e.size&&v(i,t)}})}}let b=null;function E(e){return e&&e.Math===Math&&e}try{b=E("object"==typeof globalThis&&globalThis)||E("object"==typeof window&&window)||E("object"==typeof self&&self)||E("object"==typeof global&&global)||function(){return this}()||Function("return this")()}catch(e){}const w=b;let x=null;try{const e={get passive(){return x=!0,!1}};w.addEventListener("test",null,e),w.removeEventListener("test",null,e)}catch(e){x=!1}const C=x;function A(e,t,n){return n&&(e.mark=n),t&&(e.ele=t),e}function R(e,t,n){Array.isArray(t)?t.forEach(t=>{R(e,t,n)}):"function"==typeof t?R(e,t(n),n):null!=t&&(Array.isArray(e)?e.push(t):e.appendChild(t))}function N(e,t,n,i){let s=null;switch(e){case"#text":null==s&&(s=w.document.createTextNode("")),"string"==typeof t&&(s.textContent=t);case"#comment":return null==s&&(s=w.document.createComment("")),"string"==typeof t?s.textContent=t:t.forEach(e=>{"string"!=typeof e?Array.isArray(e)?console.error(s,e):0==e.type?i.addBind(A(e,s)):i.addBind(A(e,void 0,s)):s.textContent=e}),s;default:const r=w.document.createElement(e);return R(r,n,i),Array.isArray(t)&&t.forEach(e=>{if(Array.isArray(e))r.setAttribute(e[0],e[1]);else{const t=e;i.addBind(A(t,r))}}),r}}const P=N,S=R,B=function(e,t){return new Function("g",`return ${e};`)(t||N)},O=Symbol("ElementReferenceIndex"),j={binitChangeEvents:!1};class V{static globalVar=new WeakMap;static init(e){V.globalVar.has(e)||V.globalVar.set(e,{GenerationFinish:!1,MarkEle:new WeakMap,memValues:new WeakMap,renderElements:new Set})}static getProperty(e,t){V.init(e);return V.globalVar.get(e)[t]}static setProperty(e,t,n){V.init(e);V.globalVar.get(e)[t]=n}}const D=new WeakMap;function G(e,t){const n=V.getProperty(e,"renderElements");n.has(t)||n.add(t)}function M(e,t,n,i=!1){if(e.length>1){const s=(t,n,i)=>n==i?t[e[n]]:s(t[e[n]],++n,i),r=s(t.Root,0,e.length-2),o=e[e.length-1];(i||r[o]!=n)&&(r[o]=n)}else{const s=e[0];(i||t.Root[s]!=n)&&(t.Root[s]=n)}}function T(e,t,n,i,s){null==i&&(i=0);const r=null==n?e.getValue(t[i++]):n[t[i++]];return i>=t.length?r:T(e,t,r,i)}async function $(e,t,n,i){null==n&&(n=0);const s=t[n],o=e.getContext(s.name[0]),l=T(o,s.name);if(l){const t=[];s.params&&s.params.forEach(n=>{null!=n.ct?t.push(n.ct):null!=n.va&&t.push(T(e,n.va))}),null!=i&&t.push(i),i=await l.apply(o.Root,t)}else r("fnc undefined",n,t);return++n>=t.length?i:await $(e,t,n,i)}async function L(e,t,n,i){let s;const r=t.gtpl?t.gtpl:e;if(t.link.formula&&t.link.formula.fnc){const e=t.link.formula.fnc,n=[];if(t.link.formula.vars){t.link.formula.vars.forEach(e=>{n.push(r.getValue(e[0]))})}i&&n.push(i),s=await e.apply(r.Root,n)}else t.link.vorc&&(null!=t.link.vorc.va&&(s=null!=n?n:T(r,t.link.vorc.va)),null!=t.link.vorc.ct&&(s=t.link.vorc.ct)),t.link.functions&&(s=await $(r,t.link.functions,0,s));return s}function F(e,t){let n=e;if(t.link.vorc&&t.link.vorc.va)n=e.getContext(t.link.vorc.va[0]);else if(t.link.functions){const i=t.link.functions[0];n=e.getContext(i.name[0])}return n}function J(e,t,n){const s=t[0];if(null!=e.BindTree[s])return;const o={key:s,val:e.getValue(s),pro:void 0};e.BindDef.add(o);try{e.Root.hasOwnProperty(s)||(e.Root[s]=null),Object.defineProperty(e.Root,s,{get:function(){if(void 0!==o.pro)return o.pro;if(i(o.val))return o.val;for(;o.val[u];)o.val=o.val[f];return o.pro=k(o.val,e.BoundEventProxy,o,[o.key]),o.pro},set:function(t){if(o.val=t,i(t))return delete o.pro,e.eventPRoxy(0,[o.key],t,o),o.val;for(;o.val[u];)o.val=o.val[f];return o.pro=k(o.val,e.BoundEventProxy,o,[o.key]),e.eventPRoxy(0,[o.key],t,o),o.pro}})}catch(t){r(t.message,s,e.Root)}}function W(e,t,n){let i=e.BindTree;for(let s=0,r=t.length;s<r;s++){const o=t[s];if(0==s){const i=e.getContext(o);if(J(i,t),i!=e)return n.gtpl=e,e.BindMap||(e.BindMap=new Map),e.BindMap.set(n,i),void W(i,t,n)}null==i[o]&&(i[o]={}),s<r-1?(i=i[o],null==i.tree&&(i.tree={}),i=i.tree):i=i[o]}null==i.me&&(i.me=new Set),i.me.add(n)}function z(e,t,n){let i=e.BindTree;for(let e=0,n=t.length;e<n;e++){const s=t[e];e<n-1?(i=i[s],i=i.tree):i=i[s]}return i.me}function H(e,t){if(t.link.vorc&&t.link.vorc.va&&z(e,t.link.vorc.va).delete(t),t.link.formula?.vars&&t.link.formula.vars.forEach(n=>{z(e,n).delete(t)}),t.simetric&&t.ele){const n=D.get(t.ele);if(n){const i=new Set(Array.from(n).filter(t=>t.ctx!==e));i.size?D.set(t.ele,i):D.delete(t.ele)}}}function I(e,t){let n=!1;if(t.link.vorc&&t.link.vorc.va&&z(e,t.link.vorc.va).has(t)&&(n=!0),t.link.formula?.vars&&t.link.formula.vars.forEach(i=>{z(e,i).has(t)&&(n=!0)}),!n){const n=V.getProperty(e,"renderElements");n.has(t)&&n.delete(t)}return n}function Q(e,t){if(7==t.type&&t.prop&&t.link&&t.link.vorc&&t.link.vorc.va){const{prop:n}=t;if(n.startsWith("[")&&n.endsWith("]")){!function(){if(j.binitChangeEvents)return;j.binitChangeEvents=!0;const e=new WeakMap,t=function(t){const n=t.target;if(("change"!==t.type||!e.has(n)||e.get(n)!==n.value)&&D.has(n)){const t=D.get(n);if(t){for(let e of t)M(e.va,e.ctx,n.value);e.set(n,n.value)}}};w&&"function"==typeof w.addEventListener&&(w.addEventListener("input",t),w.addEventListener("change",t))}(),t.simetric=!0,t.prop=n.slice(1,-1);const i=t.link.vorc.va,s=e.getContext(i[0]);if("value"==t.prop&&(D.has(t.ele)||D.set(t.ele,new Set),D.get(t.ele)?.add({va:i,ctx:s})),t.prop in t.ele.constructor.prototype){const e=Object.getOwnPropertyDescriptor(t.ele.constructor.prototype,t.prop);e?Object.defineProperty(t.ele,t.prop,{get:function(){return e.get.call(this)},set:function(n){if("value"==t.prop&&"select"==t.ele.nodeName.toLowerCase()){const t=e.set.call(this,n);return e.get.call(this)==n?M(i,s,n):console.error("select value not valid",n+" not in options"),t}return M(i,s,n),e.set.call(this,n)}}):console.error("simetric attr error",t.prop," not in ",t.ele.constructor.prototype)}else console.error("simetric attr error",t.prop," in ",t.ele)}}}function _(e){if(Array.isArray(e))e.forEach(e=>{_(e)});else{if(e[O]){for(const{type:t,handler:n,options:i}of e[O])e.removeEventListener(t,n,i);delete e[O]}if(e instanceof Element)for(;e.attributes.length>0;)e.removeAttribute(e.attributes[0].name);e.destroy?e.destroy(!0):e.parentNode?.removeChild(e)}}function K(e,t,n,i,s=[],r=0){if(!e)return s;if(e.me&&e.me.forEach(e=>{const o=0===r?i:void 0,l=n.slice(r);s.push([t,e,l,o])}),e.tree){const o=n[r];for(const l in e.tree)if(void 0===o||o===l){const a=void 0!==i?void 0===o?i:i[l]:void 0;K(e.tree[l],t,n,a,s,r+1)}}return s}function Z(e,t,n){if(n){const n=V.getProperty(e,"MarkEle"),i=V.getProperty(e,"memValues");t.ele?n.has(t.mark)&&t.ele!=n.get(t.mark)&&(t.ele=n.get(t.mark),i.delete(t)):t.mark&&(t.gen?(n.has(t.mark)?t.ele=n.get(t.mark):(t.ele=t.gen(t.gtpl?t.gtpl:e),n.set(t.mark,t.ele)),delete t.gen):n.has(t.mark)&&(t.ele=n.get(t.mark),i.delete(t)))}}function q(e,t=!0){e.ele&&(Array.isArray(e.ele)?e.ele.forEach(t=>{e.mark.parentNode.insertBefore(t,e.mark)}):e.mark.parentNode.insertBefore(e.ele,e.mark),t&&e.mark.remove())}function X(e,t=!0){e.ele&&(Array.isArray(e.ele)?(t&&e.ele[0].parentNode.insertBefore(e.mark,e.ele[0]),e.ele.forEach(e=>{e.remove()})):(t&&e.ele.parentNode.insertBefore(e.mark,e.ele),e.ele.remove()))}function Y(e,t,n){const i=U(e,t),s=function(e){let t=!0;if(e.mark.checks)for(let n in e.mark.checks)if(!e.mark.checks[n]){t=!1;break}return t}(t);return n&&s?(i>=0&&(e.RenderElements[i]=t),t.mark.parentNode?q(t):i>=0&&I(e,t)&&G(e,t)):(i>=0&&delete e.RenderElements[i],t.ele.parentNode?X(t):i>=0&&I(e,t)&&G(e,t)),!(n&&!s)}function U(e,t){const n=e.Elements.indexOf(t.mark);return n>=0&&(e.RenderElements||(e.RenderElements={})),n}function ee(e,t,n,i,s,r){const o={parent:t.gtpl?t.gtpl:e,generator:t.gen};if(n&&i&&s){const e={};e[n.index]=i.length,e[n.target]=s,o.context=[n.index,n.target],o.root=e}return void 0!==r&&(o.refresh=r),new te(o)}class te{ID;FncElements;Elements;RenderElements;BindTree;BindConst;BindMap;BindDef;GtplChilds;Parent;Context;Root;BoundEventProxy;cleanupCallbacks;isDestroyed=!1;constructor(e){this.ID=Math.random().toString(16).slice(2),this.BindTree={},this.BindConst=new Set,this.BindDef=new Set,this.GtplChilds=new Set,this.BoundEventProxy=this.eventPRoxy.bind(this),this.loadOptions(e)}loadOptions(e){e&&(this.Root=e.root,e.parent&&(this.Parent=e.parent),e.context&&(this.Context=new Set(e.context)),e.generator&&(this.FncElements=e.generator,this.Elements=[],S(this.Elements,this.FncElements,this)),V.setProperty(this,"GenerationFinish",!0),void 0!==e.refresh&&!0!==e.refresh||this.refresh())}getValue(e){const t=this.Root;if(t){if(t.hasOwnProperty(e))return t[e];if(void 0!==t[e])return t[e]}if(this.Parent)return this.Parent.getValue(e)}getGtplRoot(){return this.Parent?this.Parent.getGtplRoot():this}getRoot(){return this.Parent?this.Parent.getRoot():this.Root}getContext(e){return this.Context&&this.Context.has(e)?this:this.Parent?this.Parent.getContext(e):this.getGtplRoot()}addBind(e){this.checkDestroyed("addBind")||(function(e,t){if(15==t.type){if(t.link.svar&&t.link.vorc&&t.link.vorc.va){const n=t.link.vorc.va.join("");t.ele[t.link.svar]="this"==n?e.Root:T(e,t.link.vorc.va)}return!0}return!1}(this,e)||function(e,t){if(6==t.type&&t.prop){const n={gtpl:F(e,t),bind:t},i={passive:!1};["wheel","mousewheel","touchstart","touchmove"].includes(t.prop.toLowerCase())&&(i.passive=!0);const s=async function(t){const i=await L(n.gtpl,n.bind,void 0,t);if("function"==typeof i)if(n.bind.link.params){const s=[];n.bind.link.params.forEach(t=>{null!=t.ct?s.push(t.ct):null!=t.va&&s.push(T(e,t.va))}),i.apply(n.gtpl.Root,[t,...s])}else i.apply(n.gtpl.Root,[t]);else!1===i&&(t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation())};return t.ele.addEventListener(t.prop,s,!!C&&i),t.ele[O]||(t.ele[O]=[]),t.ele[O].push({type:t.prop,handler:s,options:!!C&&i}),!0}return!1}(this,e)||function(e,t){let n=!1;return t.link.formula&&t.link.formula.vars&&t.link.formula.vars.length&&(n=!0,t.link.formula.vars.forEach(n=>{W(e,n,t)})),n}(this,e)||function(e,t){let n=!1;return t.link.vorc&&t.link.vorc.va&&(n=!0,Q(e,t),W(e,t.link.vorc.va,t)),t.link.functions&&t.link.functions.forEach(i=>{i.params&&i.params.forEach(i=>{i.va&&(n=!0,W(e,i.va,t))})}),n}(this,e)||this.BindConst.add(e),V.getProperty(this,"GenerationFinish")&&this.launchChange(4,e))}checkDestroyed(e){return!!this.isDestroyed&&(console.warn(`[GTPL] Cannot perform ${e} on destroyed component`,this.ID),!0)}destroy(e=!0){a(()=>{c(()=>{if(this.isDestroyed)console.warn("[GTPL] Component already destroyed",this.ID);else{if(this.cleanupCallbacks&&this.cleanupCallbacks.size>0&&(this.cleanupCallbacks.forEach(e=>{try{e()}catch(e){console.error("[GTPL] Error in cleanup callback:",e)}}),this.cleanupCallbacks.clear()),this.isDestroyed=!0,this.GtplChilds.forEach(e=>e.destroy(!1)),this.GtplChilds.clear(),this.BindDef){for(const e of this.BindDef)v(e.val,this.BoundEventProxy);this.BindDef.clear()}if(this.BindMap){for(const[e,t]of this.BindMap)H(t,e);this.BindMap.clear()}if(e&&(_(this.Elements),this.RenderElements)){const e=Array.isArray(this.Elements)?this.Elements.length:1;for(let t=0;t<e;t++){const e=this.RenderElements[t];e&&(e.ele&&_(e.ele),e.eles&&_(e.eles))}this.RenderElements=null}this.Elements=null,this.Root=null,this.BindTree=null,this.BindConst=null,this.Context=null,this.Parent=null}})}),h()}onCleanup(e){this.isDestroyed||"function"==typeof e&&this.cleanupCallbacks.add(e)}refresh(){for(let e of this.BindDef)this.eventPRoxy(4,[],void 0,e);if(this.BindMap)for(let[e,t]of this.BindMap)t.launchChange(5,e);if(this.BindConst)for(let e of this.BindConst)this.launchChange(6,e)}addTo(e){if(!this.checkDestroyed("addBind"))if(this.RenderElements){const t=[];(Array.isArray(this.Elements)?this.Elements:[this.Elements]).forEach((e,n)=>{if(this.RenderElements[n]){const e=this.RenderElements[n];e.ele?t.push(e.ele):e.eles&&(e.eles.forEach(e=>e.addTo(t)),t.push(e.mark))}else t.push(e)}),S(e,t,this)}else S(e,this.Elements,this)}eventPRoxy(e,t,n,i){const s=t;s?.shift(),K(this.BindTree[i.key],e,t,n,[],1).forEach(e=>this.launchChange.apply(this,e))}async launchChange(e,t,n,i){if(this.checkDestroyed("launchChange"))return;if(6==t.type)return;const s=await L(this,t,i);let o=this;switch(t.type){case 0:o=await async function(e,t,n,i){t=F(t,n);const s=V.getProperty(t,"memValues");if(null!=i){if(s.has(n)&&s.get(n)==i)return t;s.set(n,i)}return n.ele.textContent=i,t}(0,this,t,s);break;case 7:o=await async function(e,t,n,i){t=F(t,n);const s=(e,t)=>{if(void 0!==n.ele[e]&&null!==n.ele[e]){if(null==t)""!==n.ele[e]&&(n.ele[e]=null);else if(n.ele[e]!=t)try{n.ele[e]=t}catch(t){r(t.message,n.ele,e)}}else null==t?n.ele.removeAttribute(e):n.ele.getAttribute(e)!=t&&n.ele.setAttribute(e,t)};if(n.prop)s(n.prop,i);else if(null==i)n.attrs&&(n.attrs.forEach(e=>{s(e,null)}),delete n.attrs);else{n.attrs||(n.attrs=[]),n.attrs.filter(e=>!(e in i)).forEach(e=>{s(e,null)}),n.attrs.length=0;for(let e in i)n.attrs.push(e),s(e,i[e])}return t}(0,this,t,s);break;case 9:o=await async function(e,t,n,i){return t=F(t,n),void 0!==i&&n.ele.innerHTML!=i&&(n.ele.innerHTML=i),t}(0,this,t,s);break;case 8:o=await async function(e,t,n,i){t=F(t,n);const s=V.getProperty(t,"memValues");return s.has(n)&&s.get(n)==i||(s.set(n,i),n.prop&&(n.ele.style[n.prop]=i)),t}(0,this,t,s);break;case 1:case 2:o=await async function(e,t,n,i){t=F(t,n);const s=2==n.type?!i:!!i;if(n.mark.checks||(n.mark.checks={}),n.mark.checks[n.type]=s,Z(t,n,s),!n.ele)return t;const r=V.getProperty(t,"memValues");return r.has(n)&&r.get(n)===s||Y(t,n,s)&&r.set(n,s),t}(0,this,t,s);break;case 5:o=await async function(e,t,n,i,s){t=F(t,n),n.eles||(n.eles=[]);const r=n.eles,o=n.link.index,l=[],a=[],h=Array.isArray(s)&&s.length?s[0]:void 0;if(isNaN(h))if(i&&i.length){if("length"==h&&r.length==i.length)return t;i.forEach((e,i)=>{if(i>=r.length){const s=ee(t,n,o,r,e,!1);r.push(s),l.push([s,i])}else r[i].Root[o.target]=e}),r.length>i.length&&r.splice(i.length,r.length-i.length).forEach((e,t)=>{a.push([e,t])})}else r.length&&(r.forEach((e,t)=>{a.push([e,t])}),r.length=0);else{const c=s;if(0==e){let e=!1;if(c.length>1)e=!0;else if(1==c.length&&r.length==i.length)return r[h].Root[o.target]=i[h],t;if(e){const e=r[h];c.shift(),M(c,{Root:e.Root[o.target]},T(t,c,i[h]),!0)}else{const e=ee(t,n,o,r,i[h],!1);r.push(e),l.push([e,h])}}if(1==e)if(c.length>1)r[h].Root[o.target]=i[h];else{const e=r.splice(h,1)[0];a.push([e,h])}}if(a.length&&a.forEach(e=>{const[n,i]=e;n.destroy(),t.GtplChilds.delete(n)}),l.length){const e=U(t,n);e>=0&&(t.RenderElements[e]||(t.RenderElements[e]=n));const i=[];l.forEach(e=>{const[n,s]=e;n.addTo(i),t.GtplChilds.add(n)}),n.mark.parentNode?(q({type:n.type,link:n.link,ele:i,mark:n.mark},!1),l.forEach(e=>{e[0].refresh()})):e>=0&&I(t,n)&&G(t,n)}return t}(e,this,t,s,n);break;case 3:o=await async function(e,t,n,i){t=F(t,n);const s=null!=i;if(n.mark.checks||(n.mark.checks={}),n.mark.checks[n.type]=s,Z(t,n,s),n.mark.checks||(n.mark.checks={}),n.mark.checks[n.type]=null!=i,!n.ele)return t;const r=V.getProperty(t,"memValues");if(r.has(n)&&r.get(n)===i)return t;if(r.set(n,i),n.case&&n.case.length){if(n.eles&&n.eles.length&&(n.eles.forEach(e=>{X(e.refCase),e.destroy(),t.GtplChilds.delete(e)}),delete n.eles),!I(t,n))return t;if(s){if(!n.case[0].mark){const e={};for(let t=0,i=n.ele.childNodes.length;t<i;t++){const i=n.ele.childNodes[t];8===i.nodeType&&6==i.textContent.length&&(e[i.textContent]=i)}for(let t=0,i=n.case.length;t<i;t++){const i=n.case[t];!i.mark&&i.uid&&(i.mark=e[i.uid])}}for(let e=0,s=n.case.length;e<s;e++){const s=n.case[e];if(await L(t,s)==i){const e=ee(t,s,void 0,void 0,void 0,!1);s.ele=e.Elements,s.eles=[e],e.refCase=s,t.GtplChilds.add(e),n.eles=s.eles;break}}}}return Y(t,n,s)&&s&&(n.eles[0].refresh(),q(n.eles[0].refCase)),t}(0,this,t,s);break;case 12:o=await async function(e,t,n,i){t=F(t,n);const s=null!=i,r=V.getProperty(t,"memValues");if(r.has(n)&&r.get(n)==i)return t;r.set(n,i);let o=!1;if(n.eles?(o=!0,n.eles[0].destroy(),t.GtplChilds.delete(n.eles[0]),delete n.eles):n.ele&&X(n),!s)return t;if(o&&!I(t,n))return t;if(Array.isArray(i)||"function"==typeof i){const e=ee(t,{link:n.link,type:n.type,gtpl:n.gtpl,gen:i});n.eles=[e],t.GtplChilds.add(e),n.ele=e.Elements}else n.ele=i;return V.getProperty(t,"MarkEle").set(n.mark,n.ele),Y(t,n,s),t}(0,this,t,s)}!function(e,t){const n=V.getProperty(e,"renderElements");if(!n.has(t))return;(Array.isArray(e.Elements)?e.Elements:[e.Elements]).forEach((t,i)=>{const s=e.RenderElements[i];if(s&&n.has(s)){let e=!0;if(s.ele){const t=Array.isArray(s.ele)?s.ele[0]:s.ele;s.mark.parentNode||t.parentNode?s.mark.parentNode&&!t.parentNode&&(q(s),s.eles&&(s.eles[0].refresh(),s.eles[0].refCase&&q(s.eles[0].refCase))):e=!1}else if(s.eles)if(s.mark.parentNode){let e=null;const t=[];s.eles.forEach(n=>{const i=[];n.refresh(),n.addTo(i),i.forEach(n=>{n.parentNode?e||(e=n):t.push(n)})}),t.length&&q({type:s.type,link:s.link,ele:t,mark:e||s.mark},!1)}else e=!1;e&&n.delete(s)}})}(o,t)}}const ne=["abstract","await","boolean","break","byte","case","catch","char","class","const","continue","debugger","default","delete","do","double","else","enum","export","extends","false","final","finally","float","for","function","goto","if","implements","import","in","instanceof","int","interface","let","long","native","new","null","package","private","protected","public","return","short","static","super","switch","synchronized","this","throw","throws","transient","true","try","typeof","var","void","volatile","while","with","yield","arguments","async","eval","undefined"];class ie{s;i;l;r;arr_acepted;ln;constructor(){this.setAceptedAN()}getResult(){return this.r}getSingleResult(){let e=null;return this.r&&1==this.r.length&&(e=this.r[0]),e}setString(e){this.s=e,this.l=e.length,this.i=0,this.r=[]}setAceptedAN(e="_"){this.arr_acepted=Array.from(e).map(e=>e.charCodeAt(0))}checkStart(){return this.i+1<this.l&&"{"===this.s[this.i]&&"{"===this.s[this.i+1]}checkEnd(){return this.i+1<this.l&&"}"===this.s[this.i]&&"}"===this.s[this.i+1]}next(){return this.i++,!(this.i>=this.l)}nop(e=!1,t=null){let n=null;for(this.ln=null;;){if(n=this.s[this.i],t&&t.includes(n))return!0;let i=" "==n||"\t"==n||"\r"==n||"\n"==n;if(!i&&e&&(i='"'!=n&&"'"!=n&&!this.isAN(n),i&&(this.ln=n)),!i)return!0;if(!this.next())return!1}}isAN(e,t=!0){if(null==e)return!1;let n;for(let i=0,s=e.length,r=0;i<s;i++)if(r=e.charCodeAt(i),n=r>64&&r<91||r>96&&r<123||this.arr_acepted.indexOf(r)>=0,t&&(n=n||r>47&&r<58),!n)return!1;return!0}getVOrC(){let e=this.s[this.i];if('"'==e||"'"==e)return{ct:this.getConst()};if(this.isAN(e,!1))return{va:this.getVar()};if(this.isNumber(e)){const e=this.i,t=this.getNumber();if(null!==t)return{ct:t};this.i=e}return null}getVar(e=!0){let t,n=this.s[this.i],i=null;for(;;){if(!this.next())return""!=n?n.split("."):null;if(i=this.s[this.i],t=this.isAN(i),e&&!t&&(t="."==i),!t)return n.split(".");n+=i}}getConst(){const e=this.s[this.i];if(!this.next())return null;let t=this.s[this.i];if(t==e)return t="",this.next()?t:null;let n=null,i=null;for(;;){if(!this.next())return null;if(n=this.s[this.i],n==e&&"\\"!=i)return this.next()?t:null;t+=n,i=n}}isNumber(e){const t=e.charCodeAt(0);return t>=48&&t<=57}getNumber(){let e=this.s[this.i],t=null,n=!1;for(;this.next();){if(t=this.s[this.i],"."==t){if(n)return null;n=!0}else if(!this.isNumber(t))break;e+=t}return e}check(){let e,t,n,i=0,s="",r=!1;for(;;){if(this.checkStart()){if(r=!0,""!=s&&(this.r.push(s),s=""),e={},this.i+=2,i=this.i,!this.nop())return!1;if(t=this.getVOrC(),t){for(e.vorc=t;;){if(!this.nop())return!1;if(n=this.s[this.i],":"==n){if(!this.next())return!1;if(!this.nop())return!1;const i=this.getVar();if(null===i)return!1;e.functions||(e.functions=[]);const s={name:i};if(e.functions.push(s),!this.nop())return!1;if(n=this.s[this.i],"("==n){if(!this.next())return!1;if(!this.nop())return!1;if(n=this.s[this.i],null==n)break;if(")"==n){if(!this.next())return!1;continue}for(;;){if(t=this.getVOrC(),!t)return!1;if(s.params||(s.params=[]),s.params.push(t),!this.nop())return!1;if(n=this.s[this.i],null==n)break;if(","!=n){if(")"==n){if(!this.next())return!1;if(!this.nop())return!1;break}}else{if(!this.next())return!1;if(!this.nop())return!1}}}continue}break}if(n=this.s[this.i],"{"==n){if(!this.next())return!1;for(;;){if(!this.nop())return!1;if(n=this.s[this.i],null==n)break;if("}"==n){if(!this.next())return!1;if(!this.nop())return!1;break}if(","!=n){if(t=this.getVOrC(),!t)return!1;e.params||(e.params=[]),e.params.push(t)}else if(!this.next())return!1}}if(n=this.s[this.i],";"==n){if(!this.next())return!1;if(!this.nop())return!1;const t=this.getVar(!1);if(null===t)return!1;if(!this.nop())return!1;if(n=this.s[this.i],";"!=n)return!1;{if(!this.next())return!1;if(!this.nop())return!1;const n=this.getVar(!1);if(null===n)return!1;e.index={index:t.join(""),target:n.join("")}}}if(!this.nop())return!1;if(this.checkEnd())this.i++,this.r.push(e);else if(!this.searchFormula(i))return!1}else if(!this.searchFormula(i))return!1}else s+=this.s[this.i];if(!this.next())break}return""!=s&&this.r.push(s),r}searchFormula(e){let t=this.s.substring(e,this.i);for(;;){if(this.checkEnd()){this.i++,this.r.push({formula:{code:t,vars:this.findVars(t)}}),t="";break}if(t+=this.s[this.i],!this.next())return!1}return!0}findVars(e){let t=e.trim();const n=this.s,i=this.i,s=this.l;this.s=t,this.l=t.length,this.i=0;let r=[],o=[[]];const l=e=>{o[o.length-1].push(e)},a=e=>o.some(t=>t.indexOf(e)>=0),h=()=>{for(;this.i<this.l&&/\s/.test(this.s[this.i]);)this.i++},c=e=>{for(this.i++;this.i<this.l;)if("\\"===this.s[this.i])this.i+=2;else{if(this.s[this.i]===e){this.i++;break}this.i++}},u=()=>{for(this.i++;this.i<this.l;)if("\\"===this.s[this.i])this.i+=2;else if("$"===this.s[this.i]&&"{"===this.s[this.i+1]){this.i+=2;let e=1;const t=this.i;for(;this.i<this.l&&e>0;)"{"===this.s[this.i]?e++:"}"===this.s[this.i]&&e--,this.i++;const n=this.s.substring(t,this.i-1);this.findVars(n).forEach(e=>{a(e[0])||r.some(t=>t[0]===e[0])||r.push(e)})}else{if("`"===this.s[this.i]){this.i++;break}this.i++}},f=()=>{const e=this.i,t=this.getVOrC();if(t&&t.va){let n=e-1;for(;n>=0&&/\s/.test(this.s[n]);)n--;return n>=0&&"."===this.s[n]?null:t.va}return null},p=()=>{if("("!==this.s[this.i])return!1;const e=this.i;let t=0;for(;this.i<this.l;){const e=this.s[this.i];if("("===e)t++;else if(")"===e&&(t--,0===t))break;this.i++}const n=this.s.substring(e+1,this.i);return this.i++,h(),"=>"===this.s.substr(this.i,2)&&(n.split(",").forEach(e=>{const t=e.trim();t&&l(t)}),this.i+=2,!0)},d=()=>{if("catch"===this.s.substr(this.i,5)){if(this.i+=5,h(),"("===this.s[this.i]){this.i++,h();const e=f();for(e&&l(e[0]);this.i<this.l&&")"!==this.s[this.i];)this.i++;")"===this.s[this.i]&&this.i++}return!0}return!1},g=()=>{if("function"===this.s.substr(this.i,8)){this.i+=8,h();const e=f();if(e&&l(e[0]),h(),"("===this.s[this.i]){this.i++;let e="";for(;this.i<this.l&&")"!==this.s[this.i];)e+=this.s[this.i],this.i++;")"===this.s[this.i]&&this.i++,e.split(",").forEach(e=>{const t=e.trim();t&&l(t)})}return!0}return!1},m=["const","var","let","function"];for(;this.i<this.l&&(h(),!(this.i>=this.l));){const e=this.s[this.i];if("catch"===this.s.substr(this.i,5)){d();continue}if("function"===this.s.substr(this.i,8)){g();continue}if("/"===e&&"/"===this.s[this.i+1]){for(this.i+=2;this.i<this.l&&"\n"!==this.s[this.i];)this.i++;continue}if("/"===e&&"*"===this.s[this.i+1]){for(this.i+=2;this.i<this.l&&("*"!==this.s[this.i]||"/"!==this.s[this.i+1]);)this.i++;this.i+=2;continue}if('"'===e||"'"===e){c(e);continue}if("`"===e){u();continue}if("{"===e){o.push([]),this.i++;continue}if("}"===e){o.pop(),this.i++;continue}if("("===e){const e=this.i;if(p())continue;this.i=e}const t=f();if(t){if(m.indexOf(t[0])>=0){h();const e=f();e&&l(e[0]);continue}if(void 0!==w[t[0]])continue;if(ne.indexOf(t[0])>=0)continue;let e=this.i;for(;e<this.l&&/\s/.test(this.s[e]);)e++;if(":"===this.s[e])continue;if(a(t[0]))continue;r.some(e=>e[0]===t[0])||r.push(t);continue}this.i++}return this.s=n,this.i=i,this.l=s,r}}let se;const re=/([a-zA-Z\_][\w]+)\s*\=\s*([a-zA-Z][\w\.]+)/gi;function oe(e,t,n){return"g('"+e+"',"+(t||"null")+","+(n||"null")+",o)"}function le(e,t,n){if(n){let i=[];return n.forEach(e=>{i.push("const "+e.var+"="+e.gen+";")}),"((o)=>{"+i.join("")+"return "+e+"})"+(t?"":"(o)")}return"((o)=>"+e+")"+(t?"":"(o)")}function ae(e,t,n,i){let s=ue([e],!0);return s=s.substring(0,s.length-1),s=s+',"gen":'+(n||t)+(i||"")+"}",s}function he(e,t,n,i,s,r){return e.uid=t,n?(""!=i&&(i+=","),i+=ae(e,t,void 0,r)):(""!=s&&(s+=","),s+=ae(e,t,void 0,r)),{jsonAttr2:i,jsonAttr:s}}function ce(n,i,s){let r=null;switch(i){case"g-is":r=r||12;case"g-binds":r=r||11;case"g-bind":r=r||10;case"g-attr":r=r||7;case"g-if":r=r||1;case"g-notif":r=r||2;case"g-switch":r=r||3;case"g-case":r=r||4;case"g-for":r=r||5;case"g-inner":if(r=r||9,se.setString(`{{${s}}}`),se.check()){const e={type:r,link:se.getSingleResult()};return 12===r?n.unshift(e):n.push(e),!0}break;case"g-var":if(r=r||15,s.match(re)){const e=s.split(re);return n.push({type:r,link:{svar:e[1],vorc:{va:e[2].split(".")}}}),!0}break;case"g-tpl":return r=r||14,n.push({type:r,link:{vorc:{ct:s}}}),!0;case"g-style":s.includes("{{")||(s=`{{${s}}}`);case"style":let o="";if(se.setString(s),se.check()){let i=se.getResult();if(i&&i.length){if(1==i.length)return n.push({type:8,prop:"cssText",link:i[0]}),!0;const r=e(s);for(const[e,s]of Object.entries(r))se.setString(s),se.check()?(i=se.getSingleResult(),n.push({type:8,prop:e,link:i})):(o+=o?";":"",o+=`${t(e)}:${s}`);return""!=o&&n.push(["style",o]),!0}}break;default:if(se.setString(s),se.check()){const e=se.getResult();if(e&&1==e.length){const t={type:i.startsWith("on")?6:7,prop:i.startsWith("on")?i.substring(2):i,link:e[0]};return n.push(t),!0}}}return!1}function ue(e,t=!1){const n=e.map(e=>{if(Array.isArray(e)||"string"==typeof e)return JSON.stringify(e);{const t=e;if(t.link?.formula){return`{${Object.entries(t).map(([e,t])=>{if("link"===e){return`"${e}":{${Object.entries(t).map(([e,t])=>{if("formula"===e){const{vars:n,code:i}=t;if(null!=i){const t=n?.map(e=>e[0]).join(",")||"",s=i.match(/[\s;]await[\W]/gm)?" async ":"",r=`{${i}}`;return`"${e}":{"vars":${JSON.stringify(n)},"fnc":${s}function(${t})${r}}`}s("formula without code")}return`"${e}":${JSON.stringify(t)}`}).join(",")}}`}return`"${e}":${JSON.stringify(t)}`}).join(",")}}`}return JSON.stringify(e)}});return t?n.join(","):`[${n.join(",")}]`}let fe=0,pe=0;function de(){pe>=60466176&&(pe=0,fe++,fe>=26&&(fe=0));const e=String.fromCharCode(97+fe),t=pe.toString(36).padStart(5,"0");return pe++,e+t}async function ge(e,t,n,i){null==se&&(se=new ie);let s,r,o,l,a,h,c,u,f,p,d,g,m,y,k,v,b="";!1!==n&&(b="[");for(var E=0,x=e.length;E<x;E++){var C=e[E];switch(s=r=o=l=a=h=null,p=d=g=m=y="",C.nodeType){case 1:if("script"==C.nodeName.toLowerCase()){"["!=b&&(b+=","),b+=oe(C.nodeName,JSON.stringify(C.textContent));continue}c=C,k=[];for(let e=0,t=c.attributes.length,n=c.attributes;e<t;e++){const t=n.item(e);if(t)if(ce(k,t.name,t.value)){if(k.length){const e=k[k.length-1];if(e){if(12==e.type&&(a=e,k.pop()),1!=e.type&&2!=e.type||(l=e,k.pop()),5==e.type&&(s=e,k.pop()),3==e.type&&(r=e,k.pop()),4==e.type){if(!i)throw new Error("not switch");i.case||(i.case=[]),i.case.push(e),o=e,o.index=i.case.length-1,k.pop()}14==e.type&&(h=e,k.pop())}}}else k.push([t.name,t.value])}if(s&&o)throw new Error("not for and case "+Array.from(c.attributes,e=>e.name+'="'+e.value+'"').join(" "));if(l&&o)throw new Error("not if and case "+Array.from(c.attributes,e=>e.name+'="'+e.value+'"').join(" "));if(a&&(o||r||h))throw new Error("not is and ( case or switch ot tpl ) "+Array.from(c.attributes,e=>e.name+"="+e.value+'"').join(" "));if("["!=b&&""!=b&&(b+=","),h){const e=h.link.vorc.ct,n=w.document.getElementById(e);if(n)u="template"==c.nodeName.toLowerCase()?t:c,f="template"==n.nodeName.toLowerCase()?n.content.childNodes:[n],p=await ge(f,u,!0,r);else{const t=await(await fetch(e)).text(),n=(new DOMParser).parseFromString(t.trim(),"text/html");p=await ge(n.body.childNodes,u,!0,r)}}else u="template"==c.nodeName.toLowerCase()?c.content:c,f=u.childNodes,p=await ge(f,u,!0,r);if(a||l||o||s||r){v=de(),d="",g="";const e=[];if(y=ue(k),a&&({jsonAttr2:g,jsonAttr:d}=he(a,v,s,g,d)),l&&({jsonAttr2:g,jsonAttr:d}=he(l,v,s,g,d)),r){r.uid=v;const t=r.case;delete r.case,m="",t&&t.forEach(t=>{if(t.common&&(t.common.forEach(t=>e.push(t)),delete t.common),t.gen){const e=t.gen;delete t.gen,""!=m&&(m+=","),m+=ae(t,null,e)}}),({jsonAttr2:g,jsonAttr:d}=he(r,v,s,g,d,',"case":['+m+"]"))}h?"template"==c.nodeName.toLowerCase()?e.push({var:v,gen:p}):e.push({var:v,gen:le(oe(c.nodeName,y,p),!0)}):e.push({var:v,gen:a?"null":le(oe(c.nodeName,y,p),!0)}),o?(o.uid=v,o.gen=v,o.common=e,b+=le(oe("#comment","["+JSON.stringify(v)+","+d+"]"),t)):s?(l||a||r?(s.uid=de(),""!=d&&(d+=","),d+=ae(s,s.uid),e.push({var:s.uid,gen:le(oe("#comment","["+JSON.stringify(v)+","+g+"]"),!0)})):(s.uid=v,""!=d&&(d+=","),d+=ae(s,v)),b+=le(oe("#comment","["+JSON.stringify(s.uid)+","+d+"]"),t,e)):b+=le(oe("#comment","["+JSON.stringify(v)+","+d+"]"),t,e)}else h&&"template"==c.nodeName.toLowerCase()?b+=p:b+=le(oe(c.nodeName,ue(k),p),t);break;case 3:{let e=!0;if(C.nodeValue&&(se.setString(C.nodeValue),se.check())){e=!1;const t=se.getResult();t&&t.length&&t.forEach(e=>{"["!=b&&""!=b&&(b+=","),b+=oe(C.nodeName,"string"==typeof e?JSON.stringify(e):ue([{type:0,prop:"textContent",link:e}]))})}e&&("["!=b&&""!=b&&(b+=","),b+=oe(C.nodeName,JSON.stringify(C.nodeValue)))}break;case 6:"["!=b&&""!=b&&(b+=","),b+=oe(C.nodeName,JSON.stringify(C.nodeValue))}}return!1!==n&&(b+="]"),void 0===t?"(o)=>"+b:b}var me={GTpl:te,GGenerator:P,GAddToo:S,GEnableScheduled:function(e){console.log("enableScheduledHandlers",e),e||h(),o.useScheduler=e},GScheduledBatch:a,GFlush:h,jit:{GCompile:B,GCode:async function(e){if("string"==typeof e){return ge((new DOMParser).parseFromString(e.trim(),"text/html").body.childNodes)}return ge(e instanceof Node?[e]:e)}},utils:{stack:r,css2obj:e,style2css:t,globalObject:w,passiveSupported:C,isGProxy:m,unGProxy:function e(t){if(m(t)&&(t=t[f]),Array.isArray(t))return t.map(e);if(t&&"object"==typeof t){const n={};for(const i of Reflect.ownKeys(t))n[i]=e(t[i]);return n}return t},PROXYTARGET:f,ISPROXY:u,activateMemoryLeakObserver:function(){new PerformanceObserver(e=>{for(const t of e.getEntries())console.warn("Posible memory leak:",t)}).observe({entryTypes:["measure"]})}}};return me});
//# sourceMappingURL=gtpl.min.js.map
